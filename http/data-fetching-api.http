### Data Fetching API - HTTP Client Tests
### For use with JetBrains IDE HTTP Client plugin
### Version: 2.0 - Phase 3 API Routes Manual Testing
### Purpose: Comprehensive testing of data-fetching API endpoints

@baseUrl = http://localhost:3000/api/data-fetching
@contentType = application/json

### ============================================================================
### SECTION 0: SETUP - Extract IDs for testing
### ============================================================================
### Run this first to populate variables: firstPostId, firstUserId, newPostId

### 0.1 List all posts to extract user/post IDs
GET {{baseUrl}}/posts?page=1&limit=5

### Store response values for use in subsequent requests
> {%
  client.global.set("firstPostId", response.body.posts[0]?.id);
  client.global.set("firstUserId", response.body.posts[0]?.author?.id);
  console.log("âœ“ Setup complete:");
  console.log("  firstPostId:", client.global.get("firstPostId"));
  console.log("  firstUserId:", client.global.get("firstUserId"));
%}



### ============================================================================
### SECTION 1: POSTS API - GET Operations (Read)
### ============================================================================

### 1.1 Get all posts with default pagination
GET {{baseUrl}}/posts

### 1.2 Get posts with custom pagination (page 1, 20 items)
GET {{baseUrl}}/posts?page=1&limit=20

### 1.3 Get posts page 2 with limit of 10
GET {{baseUrl}}/posts?page=2&limit=10

### 1.4 Get single post by ID
GET {{baseUrl}}/posts/{{firstPostId}}

### 1.5 Get posts with maximum limit (100)
GET {{baseUrl}}/posts?page=1&limit=100

### 1.6 Get posts with small limit (5 items)
GET {{baseUrl}}/posts?page=1&limit=5


### ============================================================================
### SECTION 2: POSTS API - POST Operations (Create)
### ============================================================================

### 2.1 Create a new post (basic - requires valid authorId)
POST {{baseUrl}}/posts
Content-Type: {{contentType}}

{
  "title": "HTTP Client Test Post",
  "content": "This post was created using the JetBrains HTTP Client",
  "authorId": "{{firstUserId}}"
}

> {%
  if (response.status === 201 || response.status === 200) {
    client.global.set("newPostId", response.body.id);
    console.log("âœ“ Post created with ID:", client.global.get("newPostId"));
  } else {
    console.error("âœ— Failed to create post:", response.status);
  }
%}

### 2.2 Create another post (for testing updates and deletions)
POST {{baseUrl}}/posts
Content-Type: {{contentType}}

{
  "title": "Test Post for Updates",
  "content": "This is a test post that will be updated",
  "authorId": "{{firstUserId}}"
}

> {%
  if (response.status === 201 || response.status === 200) {
    client.global.set("updateTestPostId", response.body.id);
    console.log("âœ“ Post for update created with ID:", client.global.get("updateTestPostId"));
  }
%}

### 2.3 Create another post (for deletion testing)
POST {{baseUrl}}/posts
Content-Type: {{contentType}}

{
  "title": "Test Post for Deletion",
  "content": "This post will be deleted to test the DELETE endpoint",
  "authorId": "{{firstUserId}}"
}

> {%
  if (response.status === 201 || response.status === 200) {
    client.global.set("deleteTestPostId", response.body.id);
    console.log("âœ“ Post for deletion created with ID:", client.global.get("deleteTestPostId"));
  }
%}


### ============================================================================
### SECTION 3: POSTS API - PUT Operations (Update)
### ============================================================================

### 3.1 Update post title and content
PUT {{baseUrl}}/posts/{{updateTestPostId}}
Content-Type: {{contentType}}

{
  "title": "Updated: Test Post for Updates",
  "content": "This post has been successfully updated with new content"
}

### 3.2 Update only the title
PUT {{baseUrl}}/posts/{{updateTestPostId}}
Content-Type: {{contentType}}

{
  "title": "Updated Only Title"
}

### 3.3 Update only the content
PUT {{baseUrl}}/posts/{{updateTestPostId}}
Content-Type: {{contentType}}

{
  "content": "Only the content has been updated"
}



### ============================================================================
### SECTION 4: POSTS API - DELETE Operations
### ============================================================================

### 4.1 Delete a post (uses deleteTestPostId)
DELETE {{baseUrl}}/posts/{{deleteTestPostId}}

> {%
  if (response.status === 200) {
    console.log("âœ“ Post deleted successfully");
    client.global.set("deleteTestPostId", null);
  } else {
    console.error("âœ— Failed to delete post:", response.status);
  }
%}

### 4.2 Verify deleted post returns 404
GET {{baseUrl}}/posts/{{deleteTestPostId}}


### ============================================================================
### SECTION 5: COMMENTS API (if implemented)
### ============================================================================

### 5.1 Get comments for a post
GET {{baseUrl}}/posts/{{firstPostId}}/comments

### 5.2 Create a comment (requires valid authorId)
POST {{baseUrl}}/posts/{{firstPostId}}/comments
Content-Type: {{contentType}}

{
  "text": "Great post! Created via HTTP Client.",
  "authorId": "{{firstUserId}}"
}


### ============================================================================
### SECTION 6: SEARCH API
### ============================================================================

### 6.1 Search for posts (basic search)
GET {{baseUrl}}/search?q=data&limit=10

### 6.2 Search with single word
GET {{baseUrl}}/search?q=fetching

### 6.3 Search with custom limit
GET {{baseUrl}}/search?q=react&limit=5

### 6.4 Search with multiple words
GET {{baseUrl}}/search?q=test%20post

### 6.5 Search with no results (edge case)
GET {{baseUrl}}/search?q=nonexistenttermxyz123

### 6.6 Search with maximum limit (100)
GET {{baseUrl}}/search?q=post&limit=100

### 6.7 Search with minimal limit (1)
GET {{baseUrl}}/search?q=test&limit=1


### ============================================================================
### SECTION 7: SIMULATE DELAY API (for Suspense/Loading State Testing)
### ============================================================================

### 7.1 Simulate default 1-second delay
GET {{baseUrl}}/simulate-delay

### 7.2 Simulate 500ms delay (short)
GET {{baseUrl}}/simulate-delay?delay=500

### 7.3 Simulate 2-second delay
GET {{baseUrl}}/simulate-delay?delay=2000

### 7.4 Simulate 3-second delay
GET {{baseUrl}}/simulate-delay?delay=3000

### 7.5 Simulate 5-second delay (for streaming tests)
GET {{baseUrl}}/simulate-delay?delay=5000

### 7.6 Simulate maximum allowed delay (30 seconds)
GET {{baseUrl}}/simulate-delay?delay=30000

### 7.7 Simulate delay with category parameter
GET {{baseUrl}}/simulate-delay?delay=2000&category=demo

### 7.8 Simulate delay with another category
GET {{baseUrl}}/simulate-delay?delay=3000&category=performance


### ============================================================================
### SECTION 8: METRICS API (Performance & Stats)
### ============================================================================

### 8.1 Get performance metrics and database stats
GET {{baseUrl}}/metrics


### ============================================================================
### SECTION 9: ERROR SCENARIOS - Test Error Handling
### ============================================================================
### Tests for 400, 404, 500 error responses

### 9.1 Invalid pagination (negative page)
GET {{baseUrl}}/posts?page=-1

### 9.2 Invalid pagination (non-numeric limit)
GET {{baseUrl}}/posts?page=1&limit=abc

### 9.3 Invalid pagination (page as non-numeric)
GET {{baseUrl}}/posts?page=xyz&limit=10

### 9.4 Get non-existent post (404)
GET {{baseUrl}}/posts/nonexistent-id-123

### 9.5 Create post without title (400 - missing field)
POST {{baseUrl}}/posts
Content-Type: {{contentType}}

{
  "content": "Missing title and authorId"
}

### 9.6 Create post without content (400 - missing field)
POST {{baseUrl}}/posts
Content-Type: {{contentType}}

{
  "title": "Missing content and authorId"
}

### 9.7 Create post without authorId (400 - missing field)
POST {{baseUrl}}/posts
Content-Type: {{contentType}}

{
  "title": "Missing authorId",
  "content": "Test content"
}

### 9.8 Create post with empty body (400)
POST {{baseUrl}}/posts
Content-Type: {{contentType}}

{
}

### 9.9 Create post with invalid authorId (404)
POST {{baseUrl}}/posts
Content-Type: {{contentType}}

{
  "title": "Invalid author",
  "content": "Test content",
  "authorId": "invalid-author-id-123456"
}

### 9.10 Search without query parameter (400)
GET {{baseUrl}}/search

### 9.11 Search with empty query
GET {{baseUrl}}/search?q=

### 9.12 Invalid delay parameter (non-numeric)
GET {{baseUrl}}/simulate-delay?delay=invalid

### 9.13 Delay exceeds maximum (31 seconds - should fail)
GET {{baseUrl}}/simulate-delay?delay=31000

### 9.14 Update non-existent post (404)
PUT {{baseUrl}}/posts/nonexistent-id-123
Content-Type: {{contentType}}

{
  "title": "Updated title"
}

### 9.15 Update post with empty body (400)
PUT {{baseUrl}}/posts/{{firstPostId}}
Content-Type: {{contentType}}

{
}

### 9.16 Delete non-existent post (404)
DELETE {{baseUrl}}/posts/nonexistent-id-123



### ============================================================================
### SECTION 10: ADVANCED TESTING - Response Validation
### ============================================================================

### 10.1 Verify pagination response structure
GET {{baseUrl}}/posts?page=1&limit=10

> {%
  const body = response.body;
  console.log("Response Structure Validation:");
  console.log("  âœ“ has 'posts':", Array.isArray(body.posts));
  console.log("  âœ“ has 'pagination':", body.pagination !== undefined);
  console.log("  âœ“ has 'total':", typeof body.pagination?.total === 'number');
  console.log("  âœ“ has 'page':", typeof body.pagination?.page === 'number');
  console.log("  âœ“ has 'limit':", typeof body.pagination?.limit === 'number');
  console.log("  âœ“ posts length:", body.posts.length);
%}

### 10.2 Verify single post response includes author and comments
GET {{baseUrl}}/posts/{{firstPostId}}

> {%
  const post = response.body;
  console.log("Post Detail Validation:");
  console.log("  âœ“ has 'id':", post.id !== undefined);
  console.log("  âœ“ has 'title':", post.title !== undefined);
  console.log("  âœ“ has 'content':", post.content !== undefined);
  console.log("  âœ“ has 'author':", post.author !== undefined);
  console.log("  âœ“ author has 'email':", post.author?.email !== undefined);
  console.log("  âœ“ has '_count.comments':", post._count?.comments !== undefined);
%}

### 10.3 Verify created post response structure
POST {{baseUrl}}/posts
Content-Type: {{contentType}}

{
  "title": "Validation Test Post",
  "content": "Testing response structure",
  "authorId": "{{firstUserId}}"
}

> {%
  const post = response.body;
  console.log("Create Post Response Validation:");
  console.log("  âœ“ status:", response.status);
  console.log("  âœ“ has 'id':", post.id !== undefined);
  console.log("  âœ“ has 'createdAt':", post.createdAt !== undefined);
  console.log("  âœ“ has 'updatedAt':", post.updatedAt !== undefined);
  console.log("  âœ“ title matches:", post.title === "Validation Test Post");
  console.log("  âœ“ content matches:", post.content === "Testing response structure");
%}

### 10.4 Verify search response structure
GET {{baseUrl}}/search?q=test&limit=10

> {%
  const body = response.body;
  console.log("Search Response Validation:");
  console.log("  âœ“ has 'results':", Array.isArray(body.results));
  console.log("  âœ“ has 'query':", body.query !== undefined);
  console.log("  âœ“ has 'count':", typeof body.count === 'number');
  if (body.results.length > 0) {
    console.log("  âœ“ first result has 'id':", body.results[0].id !== undefined);
    console.log("  âœ“ first result has 'title':", body.results[0].title !== undefined);
    console.log("  âœ“ first result has 'author':", body.results[0].author !== undefined);
  }
%}

### 10.5 Verify simulate-delay response structure
GET {{baseUrl}}/simulate-delay?delay=1000

> {%
  const body = response.body;
  console.log("Simulate-Delay Response Validation:");
  console.log("  âœ“ has 'id':", body.id !== undefined);
  console.log("  âœ“ has 'delay':", typeof body.delay === 'number');
  console.log("  âœ“ has 'actualDelay':", typeof body.actualDelay === 'number');
  console.log("  âœ“ has 'category':", body.category !== undefined);
  console.log("  âœ“ delay ~= actualDelay (Â±50ms):", Math.abs(body.delay - body.actualDelay) < 100);
%}


### ============================================================================
### DOCUMENTATION & USAGE GUIDE
### ============================================================================

# âš¡ QUICK START
# 1. Start dev server:          pnpm dev
# 2. Seed database:              pnpm seed
# 3. Open this file in WebStorm
# 4. Use Ctrl+Alt+Enter to run requests (or click green arrow)

# ðŸ“‹ FILE ORGANIZATION
# Section 0: SETUP - Extract IDs (run first!)
# Section 1: GET Operations - Read posts
# Section 2: POST Operations - Create posts
# Section 3: PUT Operations - Update posts
# Section 4: DELETE Operations - Delete posts
# Section 5: COMMENTS API - If implemented
# Section 6: SEARCH API - Post search
# Section 7: SIMULATE DELAY - For loading state testing
# Section 8: METRICS API - Performance stats
# Section 9: ERROR SCENARIOS - Error handling tests
# Section 10: ADVANCED - Response validation scripts

# ðŸ”‘ VARIABLE REFERENCE
# @baseUrl = http://localhost:3000/api/data-fetching
# @contentType = application/json
# firstPostId = Populated by Section 0 request 0.1
# firstUserId = Populated by Section 0 request 0.1
# newPostId = Populated by Section 2 requests
# updateTestPostId = Populated by Section 2 request 2.2
# deleteTestPostId = Populated by Section 2 request 2.3

# ðŸ’¡ TIPS & TRICKS
# - Use Ctrl+Alt+Enter or click the green arrow to execute a request
# - Response appears in right panel with tabs: Response, Headers, Cookies
# - Use > {% %} blocks to extract and store variables from responses
# - Run Section 0 first to populate testing variables
# - Test error scenarios in Section 9 to verify error handling
# - Use Section 10 advanced tests to validate response structures

# ðŸ§ª TESTING WORKFLOW
# 1. Run Section 0.1 to extract firstPostId and firstUserId
# 2. Run Section 1 tests to verify GET operations
# 3. Run Section 2 tests to create test posts
# 4. Run Section 3 tests to verify PUT operations (uses updateTestPostId)
# 5. Run Section 4 tests to verify DELETE operations
# 6. Run Section 6 tests to verify search functionality
# 7. Run Section 7 tests to verify delay simulation
# 8. Run Section 9 tests to verify error handling
# 9. Run Section 10 tests to validate response structures

# ðŸ“– HTTP CLIENT SYNTAX REFERENCE
# GET {{baseUrl}}/path
# POST {{baseUrl}}/path
# Content-Type: {{contentType}}
# { "field": "value" }
#
# Response Handling:
# > {%
#   client.global.set("varName", value);
#   console.log("Message");
# %}

# ðŸ”— RELATED FILES
# - Route Implementation: src/app/api/data-fetching/*/route.ts
# - Test Suite: src/__tests__/api/data-fetching/*.test.ts
# - Error Handling: src/__tests__/api/error-handling.test.ts
# - Database Setup: docs/database-setup.md
# - Implementation Plan: docs/implent-plan-fetching-data.md
# - Test Plan: docs/test-plan.md

# ðŸ“š REFERENCE DOCUMENTATION
# - JetBrains HTTP Client: https://www.jetbrains.com/help/idea/http-client-in-product-code-editor.html
# - Next.js API Routes: https://nextjs.org/docs/app/building-your-application/routing/route-handlers
# - Prisma Documentation: https://www.prisma.io/docs/
# - React Query: https://tanstack.com/query/latest

